extends layout

block content
    .header
        h1 Create New Post
        p Compose your post and schedule it for later

    .card
        .card-body
            form#postForm(method='POST', action='/admin/save', enctype='multipart/form-data')
                .form-group
                    label.form-label(for='text') Post Text
                    textarea.form-control#text(name='text', rows='5', placeholder='What do you want to share?')

                .form-group
                    label.form-label Attachments
                    .file-upload#fileUpload
                        .file-upload-icon ðŸ“Ž
                        p Click to upload images or videos
                        input(type='file', id='fileInput', accept='image/*,video/*', multiple, onchange='handleFileUpload(event)')

                    #previewContainer.preview-grid

                #attachmentData

                .form-group
                    label.form-label(for='scheduleDate') Schedule (optional)
                    .row
                        .col
                            input.form-control#scheduleDate(type='date', name='scheduleDate')
                        .col
                            input.form-control#scheduleTime(type='time', name='scheduleTime', min='00:00', max='23:59')

                .form-group
                    label.form-label(for='replyControl') Reply Control
                    select.form-control#replyControl(name='replyControl')
                        option(value='') Everyone can reply
                        option(value='mentioned_only') Only mentioned can reply
                        option(value='followers_only') Only followers can reply

                .form-group
                    label.form-label(for='topicTag') Topic Tag
                    input.form-control#topicTag(type='text', name='topicTag', placeholder='e.g., travel, food, tech')

                .form-group
                    label.form-label(for='linkAttachment') Link Attachment
                    input.form-control#linkAttachment(type='url', name='linkAttachment', placeholder='https://example.com')

                .form-group
                    .form-check
                        input.form-check-input#spoilerMedia(type='checkbox', name='spoilerMedia')
                        label.form-check-label(for='spoilerMedia') Mark as spoiler

                .action-buttons
                    button.btn.btn-success(type='button', onclick='publishNow()') Publish Now
                    button.btn.btn-secondary(type='submit', name='saveType', value='draft') Save as Draft
                    button.btn.btn-primary(type='submit', name='saveType', value='schedule') Schedule Post

block scripts
    script.
        let uploadedFiles = [];
        let currentSaveType = 'draft'; // Track which button was clicked

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Publish post immediately
        async function publishNow() {
            const form = document.getElementById('postForm');
            const formData = new FormData(form);

            // Collect attachment data
            const attachmentDataInputs = document.querySelectorAll('#attachmentData input');
            attachmentDataInputs.forEach(input => {
                formData.append(input.name, input.value);
            });

            const publishButton = form.querySelector('button[onclick="publishNow()"]');
            publishButton.disabled = true;
            publishButton.textContent = 'Publishing...';

            try {
                const response = await fetch('/admin/publish-now', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Post published successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin/scheduled';
                    }, 1500);
                } else {
                    showToast(data.message || 'Failed to publish post', 'error');
                    publishButton.disabled = false;
                    publishButton.textContent = 'Publish Now';
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                publishButton.disabled = false;
                publishButton.textContent = 'Publish Now';
            }
        }

        // Set saveType when buttons are clicked
        document.addEventListener('DOMContentLoaded', () => {
            const draftBtn = document.querySelector('button[name="saveType"][value="draft"]');
            const scheduleBtn = document.querySelector('button[name="saveType"][value="schedule"]');

            if (draftBtn) {
                draftBtn.addEventListener('click', () => {
                    currentSaveType = 'draft';
                });
            }

            if (scheduleBtn) {
                scheduleBtn.addEventListener('click', () => {
                    currentSaveType = 'schedule';
                });
            }
        });

        // Form submission handler
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);

            // Add saveType from our tracked variable
            formData.append('saveType', currentSaveType);

            console.log('Saving with saveType:', currentSaveType);

            try {
                const response = await fetch('/admin/save', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message || 'Post saved successfully!', 'success');

                    setTimeout(() => {
                        window.location.href = '/admin/scheduled';
                    }, 1000);
                } else {
                    showToast(data.message || 'Failed to save post', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        });

        async function handleFileUpload(event) {
            const files = event.target.files;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/admin/upload/file', {
                        method: 'POST',
                        body: formData,
                    });

                    const data = await response.json();

                    if (data.success) {
                        uploadedFiles.push(data.file);
                        displayPreview(data.file);
                        showToast('File uploaded successfully!', 'success');
                    } else {
                        showToast(data.message || 'Failed to upload file', 'error');
                    }
                } catch (error) {
                    showToast('Error uploading file: ' + error.message, 'error');
                }
            }
        }

        function displayPreview(file) {
            const container = document.getElementById('previewContainer');
            const preview = document.createElement('div');
            preview.className = 'preview-item';
            preview.dataset.fileId = file.id;

            if (file.mime_type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = file.url;
                preview.appendChild(img);
            } else {
                const video = document.createElement('video');
                video.src = file.url;
                video.controls = true;
                preview.appendChild(video);
            }

            const removeBtn = document.createElement('button');
            removeBtn.className = 'preview-remove';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.onclick = () => removeFile(file.id);
            preview.appendChild(removeBtn);

            container.appendChild(preview);
            updateAttachmentData();
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            const preview = document.querySelector(`[data-file-id="${fileId}"]`);
            if (preview) {
                preview.remove();
            }
            updateAttachmentData();
        }

        function updateAttachmentData() {
            const container = document.getElementById('attachmentData');
            container.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const typeInput = document.createElement('input');
                typeInput.type = 'hidden';
                typeInput.name = 'attachmentType';
                typeInput.value = file.mime_type.startsWith('image/') ? 'Image' : 'Video';
                container.appendChild(typeInput);

                const urlInput = document.createElement('input');
                urlInput.type = 'hidden';
                urlInput.name = 'attachmentUrl';
                urlInput.value = file.url;
                container.appendChild(urlInput);

                const altInput = document.createElement('input');
                altInput.type = 'hidden';
                altInput.name = 'attachmentAltText';
                altInput.value = '';
                container.appendChild(altInput);
            });
        }

        document.getElementById('fileUpload').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
